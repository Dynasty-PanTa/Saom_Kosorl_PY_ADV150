<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
  const { createApp } = Vue

createApp({
  delimiters: ['[[', ']]'],
  mounted() {
    const saved = localStorage.getItem('cart');
    if (saved) {
      this.cart_list = JSON.parse(saved).map(item => ({
        ...item,
        quantity: item.quantity || 1
      }));
    }
  },
  data() {
    return {
      name: '',
      phone: '',
      email: '',
      address: '',
      cart_list: JSON.parse(localStorage.getItem('cart') || '[]')
    }
  },
  computed: {
    total() {
      return this.cart_list
        .reduce((acc, item) => acc + item.price * item.quantity, 0)
        .toFixed(2);
    }
  },
  methods: {
    saveCart() {
      localStorage.setItem('cart', JSON.stringify(this.cart_list));
    },

    addToCart(item) {
        Swal.fire({
          title: "Item Added!",
          icon: "success",
          draggable: true
        });
      const existingItem = this.cart_list.find(p => p.id === item.id);
      if (existingItem) {

        existingItem.quantity += 1;

      } else {
        this.cart_list.push({ ...item, quantity: 1 });
      }
      localStorage.setItem('cart', JSON.stringify(this.cart_list));
    },

    removeCartItem(index) {
      Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, delete it!"
      }).then((result) => {
        if (result.isConfirmed) {
          this.cart_list.splice(index, 1)
          localStorage.setItem('cart', JSON.stringify(this.cart_list))
        }
      });
    },

    async submitOrder() {
      if (!this.name || !this.phone || !this.email || !this.address) {
        Swal.fire('Please fill in all the required fields.', '', 'error');
        return;
      }

      // Show loading alert
      Swal.fire({
        title: 'Submitting your order...',
        html: 'Please wait while we process your order.',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      try {
        const res = await fetch('/checkout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: this.name,
            phone: this.phone,
            email: this.email,
            address: this.address,
            cart: this.cart_list,
            total: this.total
          })
        });

        const result = await res.json();

        if (result.success) {
          // Success message after loading
          Swal.fire({
            title: 'Thank you for your order!',
            text: 'An invoice has been sent to your email and Telegram.',
            icon: 'success',
            confirmButtonText: 'OK'
          }).then(() => {
            localStorage.removeItem('cart');
            window.location.href = '/';
          });
        } else {
          Swal.fire('Failed to send invoice', result.error || 'Unknown error', 'error');
        }
      } catch (err) {
        Swal.fire('Error', 'Error sending order: ' + err.message, 'error');
      }
    }

  }
}).mount('#app')

</script>


<script>
    const {createApp, ref} = Vue;

    createApp({
        delimiters: ['[[', ']]'],
        setup() {
            const products = ref({{ products|tojson|safe }});
            const selectedProduct = ref({});
            const modalTitle = ref('Add Product');
            const file = ref(null);

            const showAddModal = () => {
                selectedProduct.value = {};
                file.value = null;
                modalTitle.value = "Add Product";
                $('#productModal').modal('show');
            };

            const showEditModal = (product) => {
                selectedProduct.value = {...product};
                file.value = null;
                modalTitle.value = "Edit Product";
                $('#productModal').modal('show');
            };

            const onFileChange = (event) => {
                file.value = event.target.files[0];
            };

            const saveProduct = () => {
                const formData = new FormData();
                formData.append('name', selectedProduct.value.name);
                formData.append('category', selectedProduct.value.category);
                formData.append('price', selectedProduct.value.price);

                if (file.value) formData.append('image', file.value);

                if (selectedProduct.value.id) formData.append('current_image', selectedProduct.value.image || '');

                const url = selectedProduct.value.id ? '/products/edit/' + selectedProduct.value.id : '/products/add';

                fetch(url, {
                    method: 'POST',
                    body: formData
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('Success', data.message, 'success');

                            if (!selectedProduct.value.id) {
                                // Add new product to table
                                products.value.push(data.product);
                            } else {
                                // Update edited product in table
                                const index = products.value.findIndex(p => p.id === selectedProduct.value.id);
                                if (index !== -1) products.value[index] = {
                                    ...selectedProduct.value,
                                    image: data.product.image
                                };
                            }

                            $('#productModal').modal('hide'); // close modal
                            file.value = null;
                            selectedProduct.value = {};
                        }
                    });
            };

            const deleteProduct = (id) => {
                Swal.fire({
                    title: 'Are you sure?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, delete!',
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/products/delete/' + id, {method: 'POST'})
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    Swal.fire('Deleted!', data.message, 'success');
                                    products.value = products.value.filter(p => p.id !== id);
                                }
                            });
                    }
                });
            };

            return {
                products,
                selectedProduct,
                modalTitle,
                showAddModal,
                showEditModal,
                saveProduct,
                deleteProduct,
                file,
                onFileChange
            };
        }
    }).mount('#app_product');
</script>