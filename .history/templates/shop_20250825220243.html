{% extends "master.html" %}

{% block title %}Shop{% endblock %}

{% block main_content %}

<div class="shop-container" style="display: flex; gap: 2rem; padding: 2rem;">

  <!-- Sidebar -->
  <div class="shop-sidebar" style="flex: 0 0 200px;">
    <h3>Search</h3>
    <input id="searchInput" class="input" type="text" placeholder="Search instruments...">

    <h3>Category</h3>
    <label><input type="checkbox" class="category-filter" value="Acoustic Guitar"> Acoustic Guitar</label><br>
    <label><input type="checkbox" class="category-filter" value="Electric Guitar"> Electric Guitar</label><br>
    <label><input type="checkbox" class="category-filter" value="Bass Guitar"> Bass Guitar</label><br>

    <h3>Price</h3>
    <label><input type="checkbox" class="price-filter" value="0-200"> $0 - $200</label><br>
    <label><input type="checkbox" class="price-filter" value="201-500"> $201 - $500</label><br>
    <label><input type="checkbox" class="price-filter" value="501-1000"> $501 - $1000</label><br>

    <button id="applyFilters" class="btn-filter" style="margin-top: 1rem;">Apply Filters</button>
  </div>

  <!-- Product Cards Grid -->
  <div class="shop-products" style="flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
    {% for product in products %}
      <div class="shop-card" 
           data-title="{{ product['title'] }}" 
           data-category="{{ product['category'] }}" 
           data-price="{{ product['price'] }}">
        <div class="shop-category">{{ product['category'] }}</div>
        <img src="{{ product['image'] }}" alt="{{ product['title'] }}" style="width: 100%; object-fit: cover; height: 150px; border-radius: 8px;">
        <div class="shop-title">{{ product['title'] }}</div>
        <div class="shop-price">${{ product['price'] }}</div>
        <button 
          @click='addToCart({{ product|tojson | safe }})' 
          class="btn btn-primary btn-add">
          Add to Cart
        </button>
      </div>
    {% endfor %}
  </div>

</div>

<script>
const searchInput = document.getElementById('searchInput');
const categoryCheckboxes = document.querySelectorAll('.category-filter');
const priceCheckboxes = document.querySelectorAll('.price-filter');
const applyButton = document.getElementById('applyFilters');
const productCards = document.querySelectorAll('.shop-card');

function applyFiltersFunc() {
    const searchText = searchInput.value.toLowerCase();

    const selectedCategories = Array.from(categoryCheckboxes)
                                   .filter(cb => cb.checked)
                                   .map(cb => cb.value);

    const selectedPrices = Array.from(priceCheckboxes)
                                .filter(cb => cb.checked)
                                .map(cb => cb.value);

    productCards.forEach(card => {
        const title = card.dataset.title.toLowerCase();
        const category = card.dataset.category;
        const price = parseFloat(card.dataset.price);

        // Check search
        const matchesSearch = title.includes(searchText);

        // Check category
        const matchesCategory = selectedCategories.length === 0 || selectedCategories.includes(category);

        // Check price
        let matchesPrice = false;
        if (selectedPrices.length === 0) {
            matchesPrice = true;
        } else {
            for (const range of selectedPrices) {
                const [min, max] = range.split('-').map(Number);
                if (price >= min && price <= max) {
                    matchesPrice = true;
                    break;
                }
            }
        }

        if (matchesSearch && matchesCategory && matchesPrice) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}

applyButton.addEventListener('click', applyFiltersFunc);

// Optional: live search while typing
searchInput.addEventListener('input', applyFiltersFunc);
</script>

{% endblock %}
